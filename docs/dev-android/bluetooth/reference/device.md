<a name="VIKbL"></a>
# 设备管理
<a name="zUI4q"></a>
## 手环绑定流程
![](https://cdn.nlark.com/yuque/__puml/92c6290c2c71b94a4f132aa4f340acc2.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCLnlKjmiLdcIiBhcyBVc2VyXG5wYXJ0aWNpcGFudCBcIkFwcFwiIGFzIEFwcFxucGFydGljaXBhbnQgXCJTREtcIiBhcyBTREtcbnBhcnRpY2lwYW50IFwi6K6-5aSHXCIgYXMgRGV2aWNlXG5cbmFjdGl2YXRlIEFwcFxuQXBwIC0-IFNESzog5Yid5aeL5YyWU0RL77ya6LCD55SoaW5pdOWIneWni-WMllxuXG5hY3RpdmF0ZSBVc2VyXG5cblVzZXIgLT4gQXBwOiDpgInmi6norr7lpIflj5Hotbfnu5HlrprmtYHnqItcbmFjdGl2YXRlIEFwcFxuXG5BcHAgLT4gU0RLOiDlj5HotbfmkJzntKLor7fmsYLvvJpzZWFyY2hcbmFjdGl2YXRlIFNES1xuXG5TREsgLS0-IEFwcDog6L-U5Zue5pCc57Si57uT5p6cXG5ub3RlIHJpZ2h0IG9mIFNESzog5q-P5qyh6L-U5Zue5Y2V5Liq6K6-5aSH77yM5LiN5aSE55CG6YeN5aSN57uT5p6cXG5cbmFjdGl2YXRlIEFwcFxuQXBwIC0-IEFwcDog6IGa5ZCI5pCc57Si57uT5p6c77yM5oyJ54Wn5L-h5Y-35by65bqm5o6S5bqPXG5cbkFwcCAtLT4gVXNlcjog5ZCR55So5oi35bGV56S65pCc57Si5Yiw55qE6K6-5aSH5YiX6KGoXG5cblVzZXIgLT4gQXBwOiDpgInmi6nkuIDkuKrmkJzntKLliLDnmoTorr7lpIfov5vooYznu5HlrppcblxuQXBwIC0-IFNESzog6LCD55SoYmluZFxuXG5TREsgLT4gRGV2aWNlOiDov57mjqXorr7lpIfvvIzojrflj5bpmo_mnLrmlbBcblxuRGV2aWNlIC0-IFNESzog6L-U5Zue6ZqP5py65pWwXG5cblNESyAtLT4gQXBwOiDlm57osINvblJlY2VpdmVSYWRvbU51bWJlclJlcXVlc3Qs5ZGK55-l6ZyA6KaB6ZqP5py65pWw6YWN5a-5XG5cbkFwcCAtPiBBcHA6IOaYvuekuumaj-acuuaVsOi-k-WFpeahhlxuXG5Vc2VyIC0-IEFwcDog6L6T5YWl6ZqP5py65pWwXG5cbkFwcCAtPiBTREs6IOiwg-eUqGlucHV0UmFuZG9tQ29kZei-k-WFpemaj-acuuaVsFxuXG5TREsgLT4gU0RLOiDpqozor4Hpmo_mnLrmlbDnmoTmraPnoa7mgKdcblxuU0RLIC0-IERldmljZTog5ZGK55-l6aqM6K-B57uT5p6cXG5cblNESyAtLT4gQXBwOiDlm57osINvblJlY2VpdmVCaW5kU3RhdGXlkYrnn6Xnu5Hlrprnu5PmnpxcblxuU0RLIC0-IFNESzog5byA5aeL5o6l5pS25pWw5o2uXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiZGdqSmgiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzkyYzYyOTBjMmM3MWI5NGE0ZjEzMmFhNGYzNDBhY2MyLnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=)

<a name="h49mf"></a>
## 体脂秤绑定流程


![](https://cdn.nlark.com/yuque/__puml/4e2643c1ec0d5aaab544b92861c6c678.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCLnlKjmiLdcIiBhcyBVc2VyXG5wYXJ0aWNpcGFudCBcIkFwcFwiIGFzIEFwcFxucGFydGljaXBhbnQgXCJTREtcIiBhcyBTREtcbnBhcnRpY2lwYW50IFwi6K6-5aSHXCIgYXMgRGV2aWNlICNvcmFuZ2VcblxuYWN0aXZhdGUgQXBwXG5BcHAgLT4gU0RLOiDliJ3lp4vljJZTREvvvJrosIPnlKhpbml05Yid5aeL5YyWXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBBcHA6IOmAieaLqeiuvuWkh-WPkei1t-e7keWumua1geeoi1xuYWN0aXZhdGUgQXBwXG5cbkFwcCAtPiBTREs6IOWPkei1t-aQnOe0ouivt-axgu-8mnNlYXJjaFxuYWN0aXZhdGUgU0RLXG5cblNESyAtLT4gQXBwOiDov5Tlm57mkJzntKLnu5Pmnpxcbm5vdGUgcmlnaHQgb2YgU0RLOiDmr4_mrKHov5Tlm57ljZXkuKrorr7lpIfvvIzkuI3lpITnkIbph43lpI3nu5PmnpxcblxuYWN0aXZhdGUgQXBwXG5BcHAgLT4gQXBwOiDogZrlkIjmkJzntKLnu5PmnpzvvIzmjInnhafkv6Hlj7flvLrluqbmjpLluo9cblxuQXBwIC0tPiBVc2VyOiDlkJHnlKjmiLflsZXnpLrmkJzntKLliLDnmoTorr7lpIfliJfooahcblxuVXNlciAtPiBBcHA6IOmAieaLqeS4gOS4quaQnOe0ouWIsOeahOiuvuWkh-i_m-ihjOe7keWumlxuXG5BcHAgLT4gU0RLOiDosIPnlKhiaW5kXG5cblNESyAtPiBEZXZpY2U6IOi_nuaOpeiuvuWkh1xuU0RLIC0-IFNESzror7vlj5borr7lpIfkv6Hmga_vvIzliKTmlq3mmK_lkKbpnIDopoHnlJ_miJBEZXZpY2VJZFxuU0RLIC0tPiBBcHA6IOWbnuiwg29uUmVjZWl2ZURldmljZUlkUmVxdWVzdCzlkYrnn6XpnIDopoHlhpnlhaVEZXZpY2VJZFxuQXBwIC0-IFNESzog6LCD55SocmVnaXN0V2l0aERldmljZUlk5YaZ5YWlRGV2aWNlSURcblNESyAtPiBEZXZpY2U6IOWGmeWFpURldmljZUlEXG5cblNESyAtLT4gQXBwOiDlm57osINvblJlY2VpdmVCaW5kU3RhdGXlkYrnn6Xnu5Hlrprnu5PmnpxcblxuU0RLIC0-IFNESzog5byA5aeL5o6l5pS25pWw5o2uXG5AZW5kdW1sIiwidHlwZSI6InB1bWwiLCJtYXJnaW4iOnRydWUsImlkIjoiRjh6NkEiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzRlMjY0M2MxZWMwZDVhYWFiNTQ0YjkyODYxYzZjNjc4LnN2ZyIsImNhcmQiOiJkaWFncmFtIn0=)

<a name="IqDQp"></a>
## 血压计绑定流程


![](https://cdn.nlark.com/yuque/__puml/4249ab439995feeba3b798b0458205a1.svg#lake_card_v2=eyJjb2RlIjoiQHN0YXJ0dW1sXG5cbmF1dG9udW1iZXJcblxuYWN0b3IgXCLnlKjmiLdcIiBhcyBVc2VyXG5wYXJ0aWNpcGFudCBcIkFwcFwiIGFzIEFwcFxucGFydGljaXBhbnQgXCJTREtcIiBhcyBTREtcbnBhcnRpY2lwYW50IFwi6K6-5aSHXCIgYXMgRGV2aWNlICNvcmFuZ2VcblxuYWN0aXZhdGUgQXBwXG5BcHAgLT4gU0RLOiDliJ3lp4vljJZTREvvvJrosIPnlKhpbml05Yid5aeL5YyWXG5cbmFjdGl2YXRlIFVzZXJcblxuVXNlciAtPiBBcHA6IOmAieaLqeiuvuWkh-WPkei1t-e7keWumua1geeoi1xuYWN0aXZhdGUgQXBwXG5cbkFwcCAtPiBTREs6IOWPkei1t-aQnOe0ouivt-axgu-8mnNlYXJjaFxuYWN0aXZhdGUgU0RLXG5cblNESyAtLT4gQXBwOiDov5Tlm57mkJzntKLnu5Pmnpxcbm5vdGUgcmlnaHQgb2YgU0RLOiDmr4_mrKHov5Tlm57ljZXkuKrorr7lpIfvvIzkuI3lpITnkIbph43lpI3nu5PmnpxcblxuYWN0aXZhdGUgQXBwXG5BcHAgLT4gQXBwOiDogZrlkIjmkJzntKLnu5PmnpzvvIzmjInnhafkv6Hlj7flvLrluqbmjpLluo9cblxuQXBwIC0tPiBVc2VyOiDlkJHnlKjmiLflsZXnpLrmkJzntKLliLDnmoTorr7lpIfliJfooahcblxuVXNlciAtPiBBcHA6IOmAieaLqeS4gOS4quaQnOe0ouWIsOeahOiuvuWkh-i_m-ihjOe7keWumlxuXG5BcHAgLT4gU0RLOiDosIPnlKhiaW5kXG5cblNESyAtPiBEZXZpY2U6IOi_nuaOpeiuvuWkh1xuU0RLIC0-IFNESzror7vlj5borr7lpIfkv6Hmga_vvIzliKTmlq3mmK_lkKbpnIDopoHnlJ_miJBEZXZpY2VJZFxuU0RLIC0tPiBBcHA6IOWbnuiwg29uUmVjZWl2ZURldmljZUlkUmVxdWVzdCzlkYrnn6XpnIDopoHlhpnlhaVEZXZpY2VJZFxuQXBwIC0-IFNESzog6LCD55SocmVnaXN0V2l0aERldmljZUlk5YaZ5YWlRGV2aWNlSURcblNESyAtPiBEZXZpY2U6IOWGmeWFpURldmljZUlEXG5TREsgLS0-IEFwcDog5Zue6LCDb25SZWNlaXZlVXNlck51bWJlcklucHV0UmVxdWVzdCzlkYrnn6XpnIDopoHlhpnlhaXnlKjmiLfnvJblj7dcbkFwcCAtPiBTREs6IOiwg-eUqGlucHV0VXNlck51bWJlcuWGmeWFpeeUqOaIt-e8luWPt1xuU0RLIC0tPiBBcHA6IOWbnuiwg29uUmVjZWl2ZUJpbmRTdGF0ZSzlkYrnn6Xnu5Hlrprnu5PmnpxcblNESyAtPiBTREs6IOW8gOWni-aOpeaUtuaVsOaNrlxuQGVuZHVtbCIsInR5cGUiOiJwdW1sIiwibWFyZ2luIjp0cnVlLCJpZCI6ImR4eWluIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC80MjQ5YWI0Mzk5OTVmZWViYTNiNzk4YjA0NTgyMDVhMS5zdmciLCJjYXJkIjoiZGlhZ3JhbSJ9)<a name="p4E6i"></a>
## 搜索&发现设备
蓝牙设备在绑定前，需要先通过扫描获得需要绑定的设备信息，首先需要调用search接口获取DeviceInfo对象，您可能需要自己去判断释放有重复的蓝牙设备信号上报并做过滤，在实际应用过程中，您可能需要经过多个扫描周期才能获得蓝牙搜索结果，调用示例：
```java
BleDeviceManager.getDefaultManager().search(10000, new Consumer<DeviceInfo>() {
            @Override
            public void accept(DeviceInfo deviceInfo) throws Exception {
                if (!scanResults.contains(deviceInfo)) {
                    scanResults.add(deviceInfo);
                }
                scanResultAdapter.notifyDataSetChanged();
                Log.i(deviceInfo.getMac());
            }
        });
```
请求参数：

| 参数名称 | 类型 | 含义 |
| --- | --- | --- |
| timeoutMills | long | 单次搜索超时时长，一般设置10～15秒，可以根据实际的应用场景来调整， 比如 |
| consumer | Consumer<DeviceInfo> | 搜索到的设备信息的回调，单个返回，需要开发者自己聚合 |

![image.png](https://cdn.nlark.com/yuque/0/2021/png/265997/1616663997679-c2ca0bcd-99a4-4bd1-8ed3-a79d96707d97.png#align=left&display=inline&height=351&margin=%5Bobject%20Object%5D&name=image.png&originHeight=351&originWidth=746&size=33445&status=done&style=none&width=746)<br />
<br />返回结果：<br />**DeviceInfo**

| 字段 | 字段类型 | 描述 |
| --- | --- | --- |
| deviceName | String | 设备名称 |
| mac | String | 设备mac地址 |
| rSSI | int | 广播信号强度 |
| deviceId | String | 设备Id |
| sn | String | 设备sn |
| modelNumber | String | 设备型号 |
| softwareVersion | String | 软件版本 |
| handwareVersion | String | 硬件版本 |
| firmwareVersion | String | 固件版本 |
| manufactureName | String | 制造商 |
| registerStatus | int | 设备注册状态（0:未注册 1:已注册） |
| manufactureId | String | 厂商Id |
| protocolType | ProtocolType | 通信协议类型 |
| dviceType | DeeviceType | 设备类型 |
| randomNumber | String | 配对过程产生的随机数 |
| batteryInfo | BatteryInfo | 电池信息 |

**<br />**<br />**ProtocolType**<br />


| A5 | A5协议（一般是手环的协议） |
| --- | --- |
| A6 | A6协议（一般是体脂秤血压计协议） |

**<br />**DeviceType**<br />


| Bracelet | 手环 |
| --- | --- |
| FatScale | 体脂秤 |
| BloodPressure | 血压计 |

<a name="mtPfx"></a>
## 停止搜索
强制中断蓝牙搜索，执行搜索过程中中断搜索或页面销毁时，请务必调用停止搜索接口，否则会影响正常的连接流程， 调用示例：
```java
BleDeviceManager.getDefaultManager().stopSearch();
```
<a name="8FYLT"></a>
## 绑定设备
搜索完成后， 向用户展示搜索到的设备列表信息， 用户选择目标设备后， 进行设备绑定操作（搜索不是必须的，如果您知道用户当前使用的设备信息， 可以不经过搜索直接调用该api进行绑定），绑定结果将通过bindReceiver接收，绑定成功后，您需要将设备信息和用户的绑定关系持久化在您的云端，再次打开App时，只需初始化sdk就可进行连接，无需再次绑定，调用示例：
```java
BleDeviceManager.getDefaultManager().bind(deviceInfo, new BindReceiver() {
            @Override
            public void onReceiveRandomNumberRequest() {
                // 显示随机数输入框
                viewModel.showInputCode(lseDeviceInfoApp);
            }

            @Override
            public void onReceiveBindState(BindState bindState) {
                if (bindState == BindState.BIND_SUCCESS) {
                    //绑定成功， do something
                } else if (bindState == BindState.RANDOM_NUMBER_MISS_MATCH) {
                    // 手环随机数不匹配 dosomething
                } else {
                    // 绑定失败，调用解绑
                    BleDeviceManager.getDefaultManager().unBind(deviceInfo.getMac());
                	// dosomething
                }
            }
            @Override
            public void onReceiveDeviceIdRequest() {
                // 向体脂秤、血压计写入deviceId（建议直接使用mac地址）
                BleDeviceManager.getDefaultManager().inputDeviceId(deviceInfo.getMac(), lseDeviceInfo.getMac().replace(":", ""));
            }

        });
```
请求参数:

| 参数名称 | 类型 | 含义 |
| --- | --- | --- |
| deviceInfo | DeviceInfo | 搜索到的设备信息 |
| bindReceiver | BindReceiver | 绑定回调，包括绑定过程和绑定结果的回调 |


<br />**BindReceiver**：

| 回调 | 参数 | 描述 |
| --- | --- | --- |
| onReceiveRadomNumberRequest | 无 | 绑定过程中收到手环随机数配对请求回调，您需要进一步调用inputRandomNumber以输入用户输入的随机数 |
| onReceiveBindState | bindState | 绑定状态回调 |
| onReceiveDeviceIdRequest | 无 | 绑定过程中收到体脂秤或血压仪写入deviceId的请求回调，您需要进一步调用inputDeviceId写入deviceId，建议您直接输入体脂秤或血压仪设备的mac地址 |

**BindState：**

| BIND_SUCCESS | 绑定成功 |
| --- | --- |
| ILLEGAL_DEVICE_RANDOM_NUMBER | 设备返回随机数非法 |
| ILLEGAL_USER_RANDOM_NUMBER | 用户输入的随机数非法 |
| INVALID_DEVICE | 无效设备 |
| AUTHORIZATION_FAILED | 鉴权失败 |
| RANDOM_NUMBER_MISS_MATCH | 随机数不匹配 |

<a name="bkF1c"></a>
### ![image.png](https://cdn.nlark.com/yuque/0/2021/png/265997/1616664048605-ea10350d-f9ff-4af3-ae44-d68dd360394d.png#align=left&display=inline&height=417&margin=%5Bobject%20Object%5D&name=image.png&originHeight=417&originWidth=746&size=21803&status=done&style=none&width=746)
<a name="b9u46"></a>
### 输入随机数
手环在收到绑定请求时， 会触发随机数绑定流程，在收到绑定流程回调onReceiveRadomNumberRequest时， 向用户显示6位数的数字输入框，输入确认后，调用该接口，进行随机数的正确性验证，验证结果将回馈到onReceiveBindState回调中，调用示例：
```java
BleDeviceManager.getDefaultManager().inputRandomNumber(lseDeviceInfoApp.getMacAddress(), code);
```
请求参数:

| 参数名称 | 类型 | 含义 |
| --- | --- | --- |
| mac | String | 正在绑定的设备mac地址 |
| randomNumber | String | 用户输入的6位数的随机数 |

![image.png](https://cdn.nlark.com/yuque/0/2021/png/265997/1616664117301-aa7bdf95-e5f9-4631-b2e6-c4145db275e9.png#align=left&display=inline&height=407&margin=%5Bobject%20Object%5D&name=image.png&originHeight=407&originWidth=746&size=26635&status=done&style=none&width=746)
<a name="d4JUu"></a>
### 写入deviceId
体脂秤或血压仪在收到绑定请求时，若设备上没有deviceId，则会触发deviceId写入流程，以生成设备唯一标识号，我们建议您直接使用mac地址作为唯一标识，不必重新生成一个唯一ID。若设备上已经写入过deviceId，则无需调用该方法（您将不会收到onReceiveDeviceIdRequest回调）, 调用示例：
```java
BleDeviceManager.getDefaultManager().inputDeviceId(lseDeviceInfo.getMac(), lseDeviceInfo.getMac().replace(":", ""));
```
请求参数:

| 参数名称 | 类型 | 含义 |
| --- | --- | --- |
| mac | String | 正在绑定的设备mac地址 |
| deviceId | String | 设备的唯一标识号，格式必须是长度为12的字符串 |


<br />若出现E-R符号， 表明您写入的deviceId不正确或deviceId为空。<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/265997/1616057286083-2b1cc9d6-c487-445b-b74c-ec9f912ce9b3.png#align=left&display=inline&height=723&margin=%5Bobject%20Object%5D&name=image.png&originHeight=723&originWidth=597&size=600890&status=done&style=none&width=597)
<a name="djf4d"></a>
## 解绑设备
当用户需要解除绑定或正在绑定中断绑定时， 需要调用unbind方法，解绑后会删除SDK中的缓存的设备信息并断开蓝牙连接，建议您在解绑成功后，清除您App本地或者云端存储的设备信息，并删除和用户的绑定关系， 调用示例：
```java
BleDeviceManager.getDefaultManager().unBind(lseDeviceInfo.getMac());
```
请求参数:

| 参数名称 | 类型 | 含义 |
| --- | --- | --- |
| mac | String | 设备mac地址 |




